# gfarm-http-gateway

HTTP gateway for Gfarm filesystem

## Features

- Web API for Gfarm
  - Gfarm: <https://github.com/oss-tsukuba/gfarm>
- Web UI (Examples of API usage)
- Login with OpenID Connect (OIDC)
  - OpenID provider: Keycloak or etc.
- Get an Access Token from the OpenID provider
- Use the Access Token to access Gfarm filesystem
  - SEE ALSO: <http://oss-tsukuba.org/gfarm/share/doc/gfarm/html/en/user/auth-sasl.html>
  - `$(pkg-config --variable=libdir libsasl2)/sasl2/gfarm.conf`: `mech_list: XOAUTH2`
  - `gfarm2.conf`: `auth enable sasl` (or `sasl_auth`)
- Refresh refresh_token automatically

## Requirements

- Python 3.11 or later
- python3-venv
- Python packages (refer to `requirements.txt`)

## Setup

- install and setup Gfarm client environment
  - gf* commands and gfarm2.conf is required
- Refer to `setup.sh`
- (For Ubuntu 24.04  or RHEL8 family)
  - Run `./setup.sh`

## Configuration parameters

- TODO (work in progress)
  - (Please edit parameters in api/gfarm_api.py)

## Start server

### Start for clients on localhost (127.0.0.1)

- `./bin/start.sh`
- For production use, it is recommended to use this with a reverse proxy.

### Start for clients of any hosts

- (not for production use)
- `./bin/start.sh 0.0.0.0:8000`

### Start for developer

- `./bin/start-dev.sh`
  - for clients of any hosts (0.0.0.0:8000)

## Development environment in Gfarm docker/dist

- setup Gfarm docker/dist (refer to (gfarm source)/docker/dist/README.md)
  - setup `For OAuth authentication`
  - setup `Use http proxy` (squid container)
- clone(git clone) gfarm-http-gateway repository to (gfarm source)/gfarm-http-gateway
- `make`
  - login to c1 container
- `ssh c2`
- `cd ~/gfarm/gfarm-http-gateway`
- `./setup.sh`
- `bin/start-dev.sh`
- use the http proxy (squid) for c2, c3, keycloak and jwt-server for a web browser
- open <http://c2:8000/> in a web browser
  - auto-redirect to <http://keycloak>
  - login: `user1/PASSWORD`
  - This page contains examples of API usage

## Client usage

### curl client for jwt-agent

- bin/jwt-curl [curl options]
  - Automatically add the access token from jwt-agent to the Authorization header
  - Available curl options
    - See the curl manual
  - Use environment variable JWT_USER_PATH if it is set.
- bin/jwt-curl-upload local_file URL [curl options]
  - Upload a file
  - Automatically use jwt-curl and --upload-file option

#### Example of jwt-curl command

- get passphrase from JWT Server
  - JWT Server code: <https://github.com/oss-tsukuba/jwt-server>
- start `jwt-agent`
  - jwt-agent code: <https://github.com/oss-tsukuba/jwt-agent>
- `gfmkdir /tmp; gfchmod 1777 /tmp`
- `cd bin`
- `./jwt-curl -s http://c2:8000/c/me`
- `./jwt-curl -s "http://c2:8000/d/?a=1&R=1&ign_err=1"`
- `dd if=/dev/urandom of=/tmp/10GiB bs=1M count=10K`
- `./jwt-curl-upload /tmp/10GiB http://c2:8000/f/tmp/10GiB`
- `./jwt-curl -o /tmp/10GiB-2 http://c2:8000/f/tmp/10GiB`

### Examples of JavaScript

- Refer to `templates/index.html`

## API docs

- Swagger (auto-generated by FastAPI)
  - <http://...:8000/docs>
