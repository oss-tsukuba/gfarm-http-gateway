services:
  gfarm-http-gateway:
    build:
      context: .
    container_name: gfarm-http-gateway
    # NOTE: Set --forwarded-allow-ips to the reverse-proxy container IP on the Compose network (or comma-separated list).
    #       Use "*" only if the gateway is never reachable directly; ensure the gateway port is not exposed or reachable.
    command: --host 0.0.0.0 --port 8000 --forwarded-allow-ips="*"
    # for Run with a Subpath
    # command: --host 0.0.0.0 --port 8000 --forwarded-allow-ips="*" --root-path /gfarm
    volumes:
      # Required: Gfarm config
      - ./config/gfarm2.conf:/config/gfarm2.conf:ro
      # Required: Gfarm HTTP gateway config
      - ./config/gfarm-http-gateway.conf:/config/gfarm-http-gateway.conf:ro
      # Required: CA certs for Gfarm
      - ./config/certs:/config/certs:ro
    # Optional: Custom development CA (e.g. self-signed root CA)
    # - ./config/dev_ca.crt:/config/dev_ca.crt:ro
    depends_on:
      - redis
    restart: unless-stopped

redis:
  image: redis
  command: ["redis-server", "/config/redis.conf"]
  volumes:
    # Required: Redis configuration
    - ./redis.conf.sample:/config/redis.conf:ro
    # Optional: TLS/mTLS certificates directory
    # Expected files:
    #   - ca.crt            : CA certificate that signed redis.crt (and client certs for mTLS)
    #   - redis.{crt,key}   : Server certificate/key for Redis (SAN should include "redis")
    #   - client.{crt,key}  : (Optional, mTLS) Client certificate/key used by the gateway
    # If you are NOT using TLS, you can remove this mount and adjust healthcheck accordingly.
    - ./redis/certs:/certs:ro
    # Optional: Persistent data directory.
    - redis-data:/data
  healthcheck:
    test: ["CMD", "redis-cli", "PING"]
    # test: ["CMD", "redis-cli", "--tls", "--cacert", "/certs/ca.crt", "PING"]  # for TLS
    interval: 10s
    timeout: 3s
    retries: 20
  restart: unless-stopped

  nginx-proxy:
    container_name: nginx-proxy
    image: nginx:latest
    ports:
      - "443:443"    # HTTPS
    volumes:
      # Required: Nginx config
      - ./nginx/gfarm.conf:/etc/nginx/conf.d/gfarm.conf:ro
      # Required for HTTPS: TLS server certs/keys for Nginx
      # set to ssl_certificate and ssl_certificate_key in Nginx config
      - ./nginx/certs:/etc/nginx/certs:ro
    depends_on:
      - gfarm-http-gateway
    restart: unless-stopped

volumes:
  redis-data:
