#!/bin/bash
set -eu
parent=$(realpath $(dirname "$0"))
source "${parent}/gfhttpc-common"

help() {
    echo "Usage: $0 [options] Gfarm-path"
    echo "  -a  Do not hide entries starting with ``.''."
    echo "  -e  Display effective permissions for a file."
    echo "  -l  List in long format."
    echo "  -R  Recursively lists subdirectories encountered."
    common_help
}

url_base=$(get_url_base)
opts=()
optind=$(common_getopt "$@")
shift $((optind - 1))

if [ $opt_verbose -eq 1 ]; then
    set -x
fi

params=()
OPTIND=1
while getopts "aelR" opt 2> /dev/null; do
    case $opt in
        a)
            params+=("a=1")
            ;;
        e)
            params+=("e=1")
            ;;
        l)
            params+=("l=1")
            ;;
        R)
            params+=("R=1")
            ;;
    esac
done
shift $((OPTIND - 1))

if [ $# -ne 1 ]; then
    help
    exit 1
fi

gfarm_path=$(echo $1 | urlpathencode)
if [ ${#params[@]} -gt 0 ]; then
  url_params="?"$(IFS='&'; echo "${params[*]}")
else
  url_params=""
fi
url="${url_base}/dir/${gfarm_path}${url_params}"

exec "${parent}/jwt-curl" "${opts[@]}" "$url"
